generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ProjectStatus {
  IDEA_SELECTED
  SCRIPT_QA_PASSED
  VOICE_RENDERED
  SCENES_PLANNED
  ASSETS_FETCHED
  VIDEO_RENDERED
  SHORTS_RENDERED
  THUMBNAIL_READY
  METADATA_READY
  SCHEDULED
  PUBLISHED
  ANALYTICS_INGESTED
  SCRIPT_REFINED
  SCRIPT_FINALIZED
  FAILED
}

enum ArtifactType {
  SCRIPT_DRAFT_JSON
  SCRIPT_REFINED_JSON
  SCRIPT_FINAL_MD
  QA_REPORT_JSON
  IDEA_JSON
  VOICE_WAV
  TIMESTAMPS_JSON
  SCENE_PLAN_JSON
  VIDEO_FINAL_MP4
  SHORT_MP4
  THUMB_PNG
  METADATA_JSON
}

enum JobStatus {
  QUEUED
  RUNNING
  SUCCEEDED
  FAILED
}

model Series {
  id        String   @id @default(uuid())
  name      String
  // "Series Bible" lưu dạng JSON: theme, tone, motifs, dos/donts, CTA style...
  bible     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  projects  Project[]
  memory    SeriesMemory?
}

model SeriesMemory {
  id        String   @id @default(uuid())
  seriesId  String   @unique
  series    Series   @relation(fields: [seriesId], references: [id], onDelete: Cascade)

  // tóm tắt + open loops + callbacks + motifs đang dùng
  memory    Json
  updatedAt DateTime @updatedAt
}

model Project {
  id              String   @id @default(uuid())
  topic           String
  language        String   @default("en")
  durationMinutes Int      @default(6)
  format          String   @default("youtube_long")
  tone            String?
  pillar          String?

  // NEW: link to Series
  seriesId        String?
  series          Series?  @relation(fields: [seriesId], references: [id], onDelete: SetNull)

  // NEW: continuity control
  // "none" | "light" | "occasionally_strong"
  continuityMode  String   @default("light")

  status          ProjectStatus @default(IDEA_SELECTED)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  artifacts       Artifact[]
  jobs            Job[]
  analytics       Analytics[]

  @@index([seriesId])
}

model Artifact {
  id        String       @id @default(uuid())
  projectId String
  project   Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)

  type      ArtifactType
  filename  String
  uri       String
  meta      Json?
  createdAt DateTime     @default(now())

  @@index([projectId, type])
}

model Job {
  id         String    @id @default(uuid())
  projectId  String
  project    Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  name       String
  status     JobStatus @default(QUEUED)
  attempt    Int       @default(0)
  error      String?
  startedAt  DateTime?
  finishedAt DateTime?
  createdAt  DateTime  @default(now())

  @@index([projectId, name])
}

model Analytics {
  id              String   @id @default(uuid())
  projectId       String
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  youtubeVideoId  String?
  ctr             Float?
  avgViewDuration Float?
  retention30s    Float?
  views7d         Int?
  subsGained7d    Int?
  capturedAt      DateTime @default(now())

  createdAt       DateTime @default(now())

  @@index([projectId, capturedAt])
}
