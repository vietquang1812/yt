<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin • Projects & Series</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { background:#0b1220; }
    .app-shell { max-width: 1150px; }
    .card { border:0; border-radius:16px; }
    .muted { color: rgba(255,255,255,.65); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    /* .soft-glow {
      background: radial-gradient(1200px 600px at 10% 10%, rgba(99,102,241,.18), transparent 60%),
                  radial-gradient(900px 500px at 90% 0%, rgba(56,189,248,.14), transparent 55%);
    } */
    .badge-soft {
      background: rgba(255,255,255,.08) !important;
      border: 1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.85);
    }
    .btn-soft {
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.9);
    }
    .btn-soft:hover { background: rgba(255,255,255,.12); }
    .table td, .table th { vertical-align: middle; }
    textarea.form-control { min-height: 320px; }
    pre { white-space: pre-wrap; word-break: break-word; }
    .nav-pills .nav-link { border-radius: 999px; }
  </style>
</head>

<body class="text-white soft-glow">
  <div class="container app-shell py-4">

    <!-- Header -->
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-4">
      <div>
        <h1 class="h4 mb-1">Admin</h1>
        <div class="muted">Projects, Series Bible & continuity settings.</div>
      </div>
      <div class="d-flex gap-2">
        <a class="btn btn-soft" href="/queues" target="_blank" rel="noreferrer">Open Bull Queues</a>
      </div>
    </div>

    <!-- Alerts -->
    <div id="alertRow" class="mb-3"></div>

    <!-- Tabs -->
    <ul class="nav nav-pills gap-2 mb-3" id="tabs">
      <li class="nav-item">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabProjects" type="button">Projects</button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabSeries" type="button">Series Bible</button>
      </li>
    </ul>

    <div class="tab-content">

      <!-- =========================
           TAB: PROJECTS
      ========================== -->
      <div class="tab-pane fade show active" id="tabProjects">
        <!-- Create Project Panel -->
        <div class="card bg-dark text-white mb-3">
          <div class="card-body">
            <div class="d-flex flex-wrap justify-content-between align-items-start gap-3">
              <div>
                <div class="fw-semibold">New Project</div>
                <div class="muted small">Create a project, then open it to run pipeline / refine / QA.</div>
              </div>
              <button id="createProjectBtn" class="btn btn-success">
                <span class="me-2">Create</span>
                <span id="createProjectSpinner" class="spinner-border spinner-border-sm d-none" aria-hidden="true"></span>
              </button>
            </div>

            <hr class="border-secondary border-opacity-25">

            <div class="row g-3">
              <div class="col-12">
                <label class="form-label muted small">Topic (required)</label>
                <input id="topic" class="form-control bg-black border-0 text-white" placeholder="e.g., Why you feel stuck even when life looks fine" />
              </div>

              <div class="col-12 col-md-6">
                <label class="form-label muted small">Pillar / Angle</label>
                <input id="pillar" class="form-control bg-black border-0 text-white" placeholder="e.g., calm psychological reframe" />
              </div>

              <div class="col-12 col-md-6">
                <label class="form-label muted small">Series</label>
                <div class="input-group">
                  <select id="seriesId" class="form-select bg-black border-0 text-white">
                    <option value="">(none)</option>
                  </select>
                  <button id="goSeriesTabBtn" class="btn btn-soft" type="button">Create series</button>
                </div>
                <div class="muted small mt-1">If set, scripts will follow Series Bible + memory for continuity.</div>
              </div>

              <div class="col-12 col-md-4">
                <label class="form-label muted small">Continuity</label>
                <select id="continuityMode" class="form-select bg-black border-0 text-white">
                  <option value="none">none</option>
                  <option value="light" selected>light</option>
                  <option value="occasionally_strong">occasionally_strong</option>
                </select>
              </div>

              <div class="col-12 col-md-4">
                <label class="form-label muted small">Language</label>
                <select id="language" class="form-select bg-black border-0 text-white">
                  <option value="en" selected>English (en)</option>
                  <option value="vi">Vietnamese (vi)</option>
                </select>
              </div>

              <div class="col-12 col-md-4">
                <label class="form-label muted small">Duration (minutes)</label>
                <input id="durationMinutes" type="number" min="1" max="60" value="6" class="form-control bg-black border-0 text-white" />
              </div>

              <div class="col-12 col-md-6">
                <label class="form-label muted small">Format</label>
                <select id="format" class="form-select bg-black border-0 text-white">
                  <option value="youtube_long" selected>youtube_long</option>
                  <option value="shorts">shorts</option>
                </select>
              </div>

              <div class="col-12 col-md-6">
                <label class="form-label muted small">Tone</label>
                <input id="tone" class="form-control bg-black border-0 text-white" placeholder="e.g., calm, grounded, mysterious" />
              </div>
            </div>
          </div>
        </div>

        <!-- List controls -->
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-2">
          <div class="muted small" id="projectCountLabel">Loading…</div>
          <div class="d-flex gap-2">
            <input id="projectSearch" class="form-control form-control-sm bg-dark text-white border-0" placeholder="Search topic…" style="width:260px" />
            <button id="refreshProjectsBtn" class="btn btn-sm btn-soft">Refresh</button>
          </div>
        </div>

        <!-- Projects table -->
        <div class="card bg-dark text-white">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-dark table-hover align-middle mb-0">
                <thead>
                  <tr>
                    <th style="width: 46%">Topic</th>
                    <th style="width: 18%">Status</th>
                    <th style="width: 18%">Series</th>
                    <th style="width: 18%">Created</th>
                  </tr>
                </thead>
                <tbody id="projectsTbody">
                  <tr><td colspan="4" class="muted">Loading…</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- =========================
           TAB: SERIES
      ========================== -->
      <div class="tab-pane fade" id="tabSeries">

        <!-- Create Series -->
        <div class="card bg-dark text-white mb-3">
          <div class="card-body">
            <div class="d-flex flex-wrap justify-content-between align-items-start gap-3">
              <div>
                <div class="fw-semibold">Create Series Bible</div>
                <div class="muted small">Use the template, only change content. Keep JSON structure unchanged.</div>
              </div>
              <div class="d-flex flex-wrap gap-2">
                <button id="resetBibleBtn" class="btn btn-soft">Reset template</button>
                <button id="createSeriesBtn" class="btn btn-primary">
                  <span class="me-2">Create series</span>
                  <span id="createSeriesSpinner" class="spinner-border sp\inner-border-sm d-none" aria-hidden="true"></span>
                </button>
              </div>
            </div>

            <hr class="border-secondary border-opacity-25">

            <div class="row g-3">
              <div class="col-12 col-lg-5">
                <label class="form-label muted small">Series name (required)</label>
                <input id="seriesName" class="form-control bg-black border-0 text-white" placeholder="e.g., Quiet Resilience Stories" />
                <div class="muted small mt-2">
                  Tip: name should match a pillar (e.g., Anxiety Reframe / Quiet Discipline / Healing Shame).
                </div>

                <div class="card bg-black text-white mt-3">
                  <div class="card-body">
                    <div class="fw-semibold mb-2">What this does</div>
                    <ul class="muted small mb-0">
                      <li>Locks tone/voice across videos.</li>
                      <li>Adds optional continuity (callbacks/open loops).</li>
                      <li>Helps avoid “AI compilation” feel.</li>
                    </ul>
                  </div>
                </div>
              </div>

              <div class="col-12 col-lg-7">
                <label class="form-label muted small">Series Bible JSON (edit content only)</label>
                <textarea id="bibleJson" class="form-control bg-black border-0 text-white mono"></textarea>
                <div class="muted small mt-1">
                  Must be valid JSON. Keep keys/structure unchanged; edit text values only.
                </div>
              </div>
            </div>

          </div>
        </div>

        <!-- Series list -->
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="muted small" id="seriesCountLabel">Loading…</div>
          <button id="refreshSeriesBtn" class="btn btn-sm btn-soft">Refresh</button>
        </div>

        <div class="card bg-dark text-white">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-dark table-hover align-middle mb-0">
                <thead>
                  <tr>
                    <th style="width: 38%">Name</th>
                    <th style="width: 32%">Core theme</th>
                    <th style="width: 20%">Updated</th>
                    <th style="width: 10%"></th>
                  </tr>
                </thead>
                <tbody id="seriesTbody">
                  <tr><td colspan="4" class="muted">Loading…</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

      </div>

    </div>
  </div>

  <script>
    const $ = (sel) => document.querySelector(sel);

    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    function fmtTime(iso) {
      try { return new Date(iso).toLocaleString(); } catch { return iso || "—"; }
    }

    function statusClass(status) {
      const s = String(status || "").toUpperCase();
      if (s.includes("FAILED")) return "bg-danger";
      if (s.includes("QA") || s.includes("READY") || s.includes("PUBLISHED")) return "bg-success";
      if (s.includes("RENDER") || s.includes("FETCH") || s.includes("PLAN")) return "bg-info text-dark";
      if (s.includes("SCHEDULE")) return "bg-warning text-dark";
      return "badge-soft";
    }

    function alert(html, variant="info") {
      $("#alertRow").innerHTML = `
        <div class="alert alert-${variant} border-0 rounded-4 mb-0" role="alert">
          ${html}
        </div>
      `;
    }
    function clearAlert() { $("#alertRow").innerHTML = ""; }

    async function apiGet(url) {
      const r = await fetch(url);
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    }

    async function apiPost(url, body) {
      const r = await fetch(url, {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify(body || {})
      });
      const text = await r.text();
      if (!r.ok) throw new Error(text);
      try { return JSON.parse(text); } catch { return text; }
    }

    // ---------------------------
    // Template Bible (format fixed)
    // ---------------------------
    const SERIES_BIBLE_TEMPLATE = {
      "core_theme": "Quiet resilience through honest self-reflection",
      "promise": "I tell intimate stories that leave you with a surprising emotional shift.",
      "voice": {
        "pov": "first_person",
        "tone": ["calm", "cinematic", "human", "emotionally honest"],
        "avoid": ["generic self-help", "lecturing", "lists", "headings", "overly motivational clichés"]
      },
      "cta_style": {
        "channel_name": "Simple Mind Studio",
        "greeting_rule": "One short greeting inside Part 1.",
        "subscribe_rule": "After the hook ends, a natural and brief subscribe call-to-action."
      },
      "motifs": ["the blue door", "2am ceiling", "a folded note"],
      "do_not": [
        "medical instructions",
        "legal advice",
        "hate/harassment",
        "illegal how-to",
        "graphic violence",
        "explicit sexual content"
      ]
    };

    function setBibleTemplate() {
      $("#bibleJson").value = JSON.stringify(SERIES_BIBLE_TEMPLATE, null, 2);
    }

    // ---------------------------
    // Data state
    // ---------------------------
    let allProjects = [];
    let allSeries = [];

    // ---------------------------
    // Series: load/render
    // ---------------------------
    async function loadSeries() {
      try {
        const series = await apiGet("/admin/api/series");
        allSeries = Array.isArray(series) ? series : (series.items || []);
        $("#seriesCountLabel").textContent = `${allSeries.length} series`;

        // render series table
        const tbody = $("#seriesTbody");
        tbody.innerHTML = "";

        if (!allSeries.length) {
          tbody.innerHTML = `<tr><td colspan="4" class="muted">No series yet. Create one above.</td></tr>`;
        } else {
          for (const s of allSeries) {
            const bible = s.bible || {};
            const coreTheme = escapeHtml(bible.core_theme || "—");
            tbody.insertAdjacentHTML("beforeend", `
              <tr>
                <td>
                  <div class="fw-semibold">${escapeHtml(s.name || "—")}</div>
                  <div class="muted small mono">${escapeHtml(s.id)}</div>
                </td>
                <td class="muted">${coreTheme}</td>
                <td class="muted">${escapeHtml(fmtTime(s.updatedAt || s.createdAt))}</td>
                <td class="text-end">
                  <button class="btn btn-sm btn-soft" data-use-series="${escapeHtml(s.id)}">Use</button>
                </td>
              </tr>
            `);
          }

          // attach use buttons
          tbody.querySelectorAll("button[data-use-series]").forEach(btn => {
            btn.addEventListener("click", () => {
              const sid = btn.getAttribute("data-use-series");
              // switch to Projects tab and set dropdown
              document.querySelector('[data-bs-target="#tabProjects"]').click();
              $("#seriesId").value = sid;
              alert(`✅ Selected series for new project.`, "success");
            });
          });
        }

        // update project create dropdown
        const sel = $("#seriesId");
        const current = sel.value;
        sel.innerHTML = `<option value="">(none)</option>` + allSeries.map(s =>
          `<option value="${escapeHtml(s.id)}">${escapeHtml(s.name)}</option>`
        ).join("");
        // restore selection if possible
        sel.value = current;

      } catch (e) {
        $("#seriesTbody").innerHTML = `<tr><td colspan="4" class="text-danger">${escapeHtml(String(e.message || e))}</td></tr>`;
        $("#seriesCountLabel").textContent = `Series (error)`;
      }
    }

    async function createSeries() {
      const name = ($("#seriesName").value || "").trim();
      if (!name) {
        alert(`Please enter a <b>Series name</b>.`, "warning");
        return;
      }

      let bible;
      try {
        bible = JSON.parse($("#bibleJson").value || "{}");
      } catch (e) {
        alert(`Bible JSON is invalid. Please fix JSON syntax.`, "danger");
        return;
      }

      $("#createSeriesBtn").disabled = true;
      $("#createSeriesSpinner").classList.remove("d-none");
      clearAlert();

      try {
        const created = await apiPost("/admin/api/series", { name, bible });
        alert(`✅ Series created.`, "success");
        // refresh list + set seriesId in project create
        await loadSeries();
        if (created?.id) $("#seriesId").value = created.id;
        // clear name (keep bible)
        $("#seriesName").value = "";
      } catch (e) {
        alert(`❌ Create series failed: <span class="mono">${escapeHtml(String(e.message || e))}</span>`, "danger");
      } finally {
        $("#createSeriesBtn").disabled = false;
        $("#createSeriesSpinner").classList.add("d-none");
      }
    }

    // ---------------------------
    // Projects: load/render
    // ---------------------------
    async function loadProjects() {
      $("#projectCountLabel").textContent = "Loading…";
      $("#projectsTbody").innerHTML = `<tr><td colspan="4" class="muted">Loading…</td></tr>`;

      try {
        const ps = await apiGet("/admin/api/projects");
        allProjects = Array.isArray(ps) ? ps : (ps.items || []);
        renderProjects();
      } catch (e) {
        $("#projectsTbody").innerHTML = `<tr><td colspan="4" class="text-danger">${escapeHtml(String(e.message || e))}</td></tr>`;
        $("#projectCountLabel").textContent = `Projects (error)`;
      }
    }

    function seriesNameById(seriesId) {
      if (!seriesId) return "";
      const s = allSeries.find(x => x.id === seriesId);
      return s?.name || "";
    }

    function renderProjects() {
      const q = ($("#projectSearch").value || "").trim().toLowerCase();
      const rows = allProjects
        .filter(p => !q || String(p.topic || "").toLowerCase().includes(q))
        .sort((a,b) => String(b.createdAt || "").localeCompare(String(a.createdAt || "")));

      $("#projectCountLabel").textContent = `${rows.length} project(s)`;

      const tbody = $("#projectsTbody");
      tbody.innerHTML = "";

      if (!rows.length) {
        tbody.innerHTML = `<tr><td colspan="4" class="muted">No projects yet.</td></tr>`;
        return;
      }

      for (const p of rows) {
        const topic = escapeHtml(p.topic || "(no topic)");
        const status = escapeHtml(p.status || "—");
        const created = fmtTime(p.createdAt);
        const seriesLabel = escapeHtml(seriesNameById(p.seriesId) || (p.seriesId ? "Series" : "—"));

        tbody.insertAdjacentHTML("beforeend", `
          <tr>
            <td>
              <div class="fw-semibold">
                <a class="link-light" href="/admin/project.html?id=${escapeHtml(p.id)}">${topic}</a>
              </div>
              <div class="muted small mono">${escapeHtml(p.id)}</div>
            </td>
            <td>
              <span class="badge ${statusClass(status)}">${status}</span>
            </td>
            <td class="muted">${seriesLabel || "—"}</td>
            <td class="muted">${escapeHtml(created)}</td>
          </tr>
        `);
      }
    }

    async function createProject() {
      const topic = ($("#topic").value || "").trim();
      if (!topic) {
        alert(`Please enter a <b>Topic</b>.`, "warning");
        return;
      }

      const body = {
        topic,
        pillar: ($("#pillar").value || "").trim() || undefined,
        seriesId: ($("#seriesId").value || "").trim() || undefined,
        continuityMode: ($("#continuityMode").value || "light"),
        language: ($("#language").value || "en"),
        durationMinutes: Number($("#durationMinutes").value || 6),
        format: ($("#format").value || "youtube_long"),
        tone: ($("#tone").value || "").trim() || undefined,
      };

      $("#createProjectBtn").disabled = true;
      $("#createProjectSpinner").classList.remove("d-none");
      clearAlert();

      try {
        const p = await apiPost("/admin/api/projects", body);
        const pid = p?.id || p?.project?.id;
        alert(`✅ Project created. Opening…`, "success");
        if (pid) location.href = `/admin/project.html?id=${encodeURIComponent(pid)}`;
        await loadProjects();
      } catch (e) {
        alert(`❌ Create project failed: <span class="mono">${escapeHtml(String(e.message || e))}</span>`, "danger");
      } finally {
        $("#createProjectBtn").disabled = false;
        $("#createProjectSpinner").classList.add("d-none");
      }
    }

    // ---------------------------
    // Wiring
    // ---------------------------
    $("#resetBibleBtn").addEventListener("click", setBibleTemplate);
    $("#createSeriesBtn").addEventListener("click", createSeries);
    $("#refreshSeriesBtn").addEventListener("click", loadSeries);

    $("#createProjectBtn").addEventListener("click", createProject);
    $("#refreshProjectsBtn").addEventListener("click", loadProjects);
    $("#projectSearch").addEventListener("input", renderProjects);

    $("#goSeriesTabBtn").addEventListener("click", () => {
      document.querySelector('[data-bs-target="#tabSeries"]').click();
      setTimeout(() => $("#seriesName").focus(), 50);
    });

    // Boot
    (async function boot(){
      setBibleTemplate();
      await loadSeries();
      await loadProjects();
    })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
